{
  "$schema": "node_modules/wrangler/config-schema.json",
  "name": "x402-api",
  "main": "src/index.ts",
  "compatibility_date": "2025-01-08",
  "compatibility_flags": ["nodejs_compat_v2"],
  // Local development settings
  "workers_dev": true,
  "preview_urls": true,
  "observability": { "enabled": false },

  /**
   * Top-level bindings are for local development only (wrangler dev).
   * These are NOT inherited by environments - each env must define its own.
   */
  "kv_namespaces": [
    {
      "binding": "METRICS",
      "id": "3f11905fdf2346a59822bd412601b789",
      "preview_id": "3f11905fdf2346a59822bd412601b789"
    },
    {
      "binding": "STORAGE",
      "id": "e53ab39b253041de87dbebf2fedbb6b3",
      "preview_id": "e53ab39b253041de87dbebf2fedbb6b3"
    }
  ],
  "ai": { "binding": "AI" },
  "durable_objects": {
    "bindings": [
      { "name": "USAGE_DO", "class_name": "UsageDO" },
      { "name": "STORAGE_DO", "class_name": "StorageDO" },
      { "name": "METRICS_DO", "class_name": "MetricsDO" }
    ]
  },
  "migrations": [
    { "tag": "v1", "new_sqlite_classes": ["UsageDO", "StorageDO"] },
    { "tag": "v2", "new_sqlite_classes": ["MetricsDO"] }
  ],
  "vars": {
    "ENVIRONMENT": "development",
    "X402_FACILITATOR_URL": "https://facilitator.stacksx402.com",
    "X402_NETWORK": "testnet",
    "X402_SERVER_ADDRESS": "ST37NMC4HGFQ1H2JSFP4H3TMNQBF4PY0MVSD1GV7Z"
  },

  /**
   * Environments
   * Note: kv_namespaces, ai, durable_objects, services are NOT inherited.
   * Each environment must explicitly define all bindings it needs.
   *
   * Secrets (set via `wrangler secret put --env <env>`):
   * - OPENROUTER_API_KEY: API key for OpenRouter
   * - HIRO_API_KEY: API key for Hiro (better rate limits)
   */
  "env": {
    "staging": {
      "name": "x402-api-staging",
      "workers_dev": false,
      "routes": [{ "pattern": "x402.aibtc.dev", "custom_domain": true }],
      "observability": { "enabled": true },
      "vars": {
        "ENVIRONMENT": "staging",
        "X402_FACILITATOR_URL": "https://facilitator.stacksx402.com",
        "X402_NETWORK": "testnet",
        "X402_SERVER_ADDRESS": "ST37NMC4HGFQ1H2JSFP4H3TMNQBF4PY0MVSD1GV7Z"
      },
      // Bindings must be duplicated per environment
      "kv_namespaces": [
        { "binding": "METRICS", "id": "c6e25952925144db9da79a5291b19782" },
        { "binding": "STORAGE", "id": "eda7add7b2fe4b96a2aedfa918d3c880" }
      ],
      "ai": { "binding": "AI" },
      "durable_objects": {
        "bindings": [
          { "name": "USAGE_DO", "class_name": "UsageDO" },
          { "name": "STORAGE_DO", "class_name": "StorageDO" },
          { "name": "METRICS_DO", "class_name": "MetricsDO" }
        ]
      }
    },
    "production": {
      "name": "x402-api-production",
      "workers_dev": false,
      "routes": [{ "pattern": "x402.aibtc.com", "custom_domain": true }],
      "observability": { "enabled": true },
      "vars": {
        "ENVIRONMENT": "production",
        "X402_FACILITATOR_URL": "https://facilitator.stacksx402.com",
        "X402_NETWORK": "mainnet",
        "X402_SERVER_ADDRESS": "SP37NMC4HGFQ1H2JSFP4H3TMNQBF4PY0MVRHQXGQE"
      },
      // Bindings must be duplicated per environment
      "kv_namespaces": [
        { "binding": "METRICS", "id": "3f11905fdf2346a59822bd412601b789" },
        { "binding": "STORAGE", "id": "e53ab39b253041de87dbebf2fedbb6b3" }
      ],
      "ai": { "binding": "AI" },
      "durable_objects": {
        "bindings": [
          { "name": "USAGE_DO", "class_name": "UsageDO" },
          { "name": "STORAGE_DO", "class_name": "StorageDO" },
          { "name": "METRICS_DO", "class_name": "MetricsDO" }
        ]
      }
    }
  }
}
